#
# <meta:header>
#   <meta:licence>
#     Copyright (c) 2019, ROE (http://www.roe.ac.uk/)
#
#     This information is free software: you can redistribute it and/or modify
#     it under the terms of the GNU General Public License as published by
#     the Free Software Foundation, either version 3 of the License, or
#     (at your option) any later version.
#
#     This information is distributed in the hope that it will be useful,
#     but WITHOUT ANY WARRANTY; without even the implied warranty of
#     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#     GNU General Public License for more details.
#
#     You should have received a copy of the GNU General Public License
#     along with this program.  If not, see <http://www.gnu.org/licenses/>.
#   </meta:licence>
# </meta:header>
#
#

# -----------------------------------------------------
# Check the details of the `natted` network.
#[user@trop03]

    source "${HOME}/libvirt.settings"

    virsh \
        --connect ${connection:?} \
        net-dumpxml \
            natted

    >   <network ipv6='yes'>
    >     <name>natted</name>
    >     <uuid>daccf157-54eb-43fc-95a2-6b6f2ba72c35</uuid>
    >     <forward mode='nat'>
    >       <nat>
    >         <port start='1024' end='65535'/>
    >       </nat>
    >     </forward>
    >     <bridge name='virbr1' stp='off' delay='0'/>
    >     <mac address='52:54:00:00:d2:be'/>
    >     <ip family='ipv4' address='192.168.210.190' netmask='255.255.255.224'>
    >       <dhcp>
    >         <range start='192.168.210.161' end='192.168.210.188'/>
    >         <host mac='52:54:0:0:D2:A1' name='Umiawyth-nat' ip='192.168.210.161'/>
    >         <host mac='52:54:0:0:D2:A2' name='Etalema-nat' ip='192.168.210.162'/>
    >         <host mac='52:54:0:0:D2:A3' name='Greand-nat' ip='192.168.210.163'/>
    >         <host mac='52:54:0:0:D2:A4' name='Nydiralle-nat' ip='192.168.210.164'/>
    >         <host mac='52:54:0:0:D2:A5' name='Kedaekoth-nat' ip='192.168.210.165'/>
    >         <host mac='52:54:0:0:D2:A6' name='Onelith-nat' ip='192.168.210.166'/>
    >         <host mac='52:54:0:0:D2:A7' name='Elaleld-nat' ip='192.168.210.167'/>
    >         <host mac='52:54:0:0:D2:A8' name='Afoaviel-nat' ip='192.168.210.168'/>
    >         <host mac='52:54:0:0:D2:A9' name='Rusaldez-nat' ip='192.168.210.169'/>
    >         <host mac='52:54:0:0:D2:AA' name='Stedigo-nat' ip='192.168.210.170'/>
    >         <host mac='52:54:0:0:D2:AB' name='Angece-nat' ip='192.168.210.171'/>
    >         <host mac='52:54:0:0:D2:AC' name='Edwalafia-nat' ip='192.168.210.172'/>
    >         <host mac='52:54:0:0:D2:AD' name='Onoza-nat' ip='192.168.210.173'/>
    >         <host mac='52:54:0:0:D2:AE' name='Fosauri-nat' ip='192.168.210.174'/>
    >         <host mac='52:54:0:0:D2:AF' name='Marpus-nat' ip='192.168.210.175'/>
    >         <host mac='52:54:0:0:D2:B0' name='Byflame-nat' ip='192.168.210.176'/>
    >         <host mac='52:54:0:0:D2:B1' name='Grerat-nat' ip='192.168.210.177'/>
    >         <host mac='52:54:0:0:D2:B2' name='Jeralenia-nat' ip='192.168.210.178'/>
    >         <host mac='52:54:0:0:D2:B3' name='Dwardoa-nat' ip='192.168.210.179'/>
    >         <host mac='52:54:0:0:D2:B4' name='Larohac-nat' ip='192.168.210.180'/>
    >         <host mac='52:54:0:0:D2:B5' name='Kaaeclya-nat' ip='192.168.210.181'/>
    >         <host mac='52:54:0:0:D2:B6' name='Elirannor-nat' ip='192.168.210.182'/>
    >         <host mac='52:54:0:0:D2:B7' name='Jeroaveth-nat' ip='192.168.210.183'/>
    >         <host mac='52:54:0:0:D2:B8' name='Rorekon-nat' ip='192.168.210.184'/>
    >         <host mac='52:54:0:0:D2:B9' name='Astalenna-nat' ip='192.168.210.185'/>
    >         <host mac='52:54:0:0:D2:BA' name='Afib-nat' ip='192.168.210.186'/>
    >         <host mac='52:54:0:0:D2:BB' name='Lotholia-nat' ip='192.168.210.187'/>
    >         <host mac='52:54:0:0:D2:BC' name='Astilamos-nat' ip='192.168.210.188'/>
    >       </dhcp>
    >     </ip>
    >   </network>


# -----------------------------------------------------
# ....
#


        172.16.x.y/16

        172.16.0.y - reserved
        172.16.1.y - physical

        172.16.2.y - work0 nodes
        172.16.3.y - work1 nodes
        172.16.4.y - work2 nodes
        172.16.5.y - work3 nodes

        172.16.6.y - trop3 nodes

            host 172.16.1.6/16

            natted 192.168.6.0/24

                mac   52:54:00:06:00:FE
                net   192.168.6.254
                mask  255.255.255.0
                range 192.168.6.1 - 192.168.6.251

                52:54:00:06:00:00     192.168.6.0 - reserved
                52:54:00:06:00:01     192.168.6.1
                52:54:00:06:00:02     192.168.6.2
                52:54:00:06:00:03     192.168.6.3

                52:54:00:06:00:04     192.168.6.4
                52:54:00:06:00:05     192.168.6.5
                52:54:00:06:00:06     192.168.6.6
                52:54:00:06:00:07     192.168.6.7

                52:54:00:06:00:08     192.168.6.8
                52:54:00:06:00:09     192.168.6.9
                52:54:00:06:00:0A     192.168.6.10
                52:54:00:06:00:0B     192.168.6.11

                52:54:00:06:00:0C     192.168.6.12
                52:54:00:06:00:0D     192.168.6.13
                52:54:00:06:00:0E     192.168.6.14
                52:54:00:06:00:0F     192.168.6.15

                52:54:00:06:00:10     192.168.6.16
                52:54:00:06:00:11     192.168.6.17
                52:54:00:06:00:12     192.168.6.18
                52:54:00:06:00:13     192.168.6.19

                52:54:00:06:00:14     192.168.6.20
                52:54:00:06:00:15     192.168.6.21
                52:54:00:06:00:16     192.168.6.22
                52:54:00:06:00:17     192.168.6.23

                52:54:00:06:00:18     192.168.6.24
                52:54:00:06:00:19     192.168.6.25
                52:54:00:06:00:1A     192.168.6.26
                52:54:00:06:00:1B     192.168.6.27

                52:54:00:06:00:1C     192.168.6.28
                52:54:00:06:00:1D     192.168.6.29
                52:54:00:06:00:1E     192.168.6.30
                52:54:00:06:00:1F     192.168.6.31

                52:54:00:06:00:FC     192.168.6.252 - reserved
                52:54:00:06:00:FD     192.168.6.253 - reserved
                52:54:00:06:00:FE     192.168.6.254 - network
                52:54:00:06:00:FF     192.168.6.255 - broadcast

                ---- ----

            routed 172.16.6.0/24

                52:54:00:06:01:00     172.16.6.0 - reserved
                52:54:00:06:01:01     172.16.6.1
                52:54:00:06:01:02     172.16.6.2
                52:54:00:06:01:03     172.16.6.3

                52:54:00:06:01:04     172.16.6.4
                52:54:00:06:01:05     172.16.6.5
                52:54:00:06:01:06     172.16.6.6
                52:54:00:06:01:07     172.16.6.7

                52:54:00:06:01:08     172.16.6.8
                52:54:00:06:01:09     172.16.6.9
                52:54:00:06:01:0A     172.16.6.10
                52:54:00:06:01:0B     172.16.6.11

                52:54:00:06:01:0C     172.16.6.12
                52:54:00:06:01:0D     172.16.6.13
                52:54:00:06:01:0E     172.16.6.14
                52:54:00:06:01:0F     172.16.6.15

                52:54:00:06:01:10     172.16.6.16
                52:54:00:06:01:11     172.16.6.17
                52:54:00:06:01:12     172.16.6.18
                52:54:00:06:01:13     172.16.6.19

                52:54:00:06:01:14     172.16.6.20
                52:54:00:06:01:15     172.16.6.21
                52:54:00:06:01:16     172.16.6.22
                52:54:00:06:01:17     172.16.6.23

                52:54:00:06:01:18     172.16.6.24
                52:54:00:06:01:19     172.16.6.25
                52:54:00:06:01:1A     172.16.6.26
                52:54:00:06:01:1B     172.16.6.27

                52:54:00:06:01:1C     172.16.6.28
                52:54:00:06:01:1D     172.16.6.29
                52:54:00:06:01:1E     172.16.6.30
                52:54:00:06:01:1F     172.16.6.31

                52:54:00:06:01:FC     172.16.6.252 - reserved
                52:54:00:06:01:FD     172.16.6.253 - reserved
                52:54:00:06:01:FE     172.16.6.254 - network
                52:54:00:06:01:FF     172.16.6.255 - broadcast

                ---- ----

            bridged 172.16.0.0/16

                52:54:00:06:02:00     172.16.6.0 - reserved
                52:54:00:06:02:01     172.16.6.1
                52:54:00:06:02:02     172.16.6.2
                52:54:00:06:02:03     172.16.6.3

                52:54:00:06:02:04     172.16.6.4
                52:54:00:06:02:05     172.16.6.5
                52:54:00:06:02:06     172.16.6.6
                52:54:00:06:02:07     172.16.6.7

                52:54:00:06:02:08     172.16.6.8
                52:54:00:06:02:09     172.16.6.9
                52:54:00:06:02:0A     172.16.6.10
                52:54:00:06:02:0B     172.16.6.11

                52:54:00:06:02:0C     172.16.6.12
                52:54:00:06:02:0D     172.16.6.13
                52:54:00:06:02:0E     172.16.6.14
                52:54:00:06:02:0F     172.16.6.15

                52:54:00:06:02:10     172.16.6.16
                52:54:00:06:02:11     172.16.6.17
                52:54:00:06:02:12     172.16.6.18
                52:54:00:06:02:13     172.16.6.19

                52:54:00:06:02:14     172.16.6.20
                52:54:00:06:02:15     172.16.6.21
                52:54:00:06:02:16     172.16.6.22
                52:54:00:06:02:17     172.16.6.23

                52:54:00:06:02:18     172.16.6.24
                52:54:00:06:02:19     172.16.6.25
                52:54:00:06:02:1A     172.16.6.26
                52:54:00:06:02:1B     172.16.6.27

                52:54:00:06:02:1C     172.16.6.28
                52:54:00:06:02:1D     172.16.6.29
                52:54:00:06:02:1E     172.16.6.30
                52:54:00:06:02:1F     172.16.6.31

                52:54:00:06:02:FC     172.16.6.252 - reserved
                52:54:00:06:02:FD     172.16.6.253 - reserved
                52:54:00:06:02:FE     172.16.6.254 - reserved
                52:54:00:06:02:FF     172.16.6.255 - reserved

                ---- ----


# -----------------------------------------------------
# Manually update the `natted` network.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        net-dumpxml \
            natted \
    > "/tmp/natted.xml"

    vi "/tmp/natted.xml"

    >   <network ipv6='yes'>
    >     <name>natted</name>
    >     <uuid>daccf157-54eb-43fc-95a2-6b6f2ba72c35</uuid>
    >     <forward mode='nat'>
    >       <nat>
    >         <port start='1024' end='65535'/>
    >       </nat>
    >     </forward>
    >     <bridge name='virbr1' stp='off' delay='0'/>
    >     <mac address='52:54:00:06:00:FE'/>
    >     <ip family='ipv4' address='192.168.6.254' netmask='255.255.255.0'>
    >       <dhcp>
    >         <range start='192.168.6.1' end='192.168.6.31'/>
    >         <host mac='52:54:00:06:00:01' name='Umiawyth-nat'  ip='192.168.6.1'/>
    >         <host mac='52:54:00:06:00:02' name='Etalema-nat'   ip='192.168.6.2'/>
    >         <host mac='52:54:00:06:00:03' name='Greand-nat'    ip='192.168.6.3'/>
    >         <host mac='52:54:00:06:00:04' name='Nydiralle-nat' ip='192.168.6.4'/>
    >         <host mac='52:54:00:06:00:05' name='Kedaekoth-nat' ip='192.168.6.5'/>
    >         <host mac='52:54:00:06:00:06' name='Onelith-nat'   ip='192.168.6.6'/>
    >         <host mac='52:54:00:06:00:07' name='Elaleld-nat'   ip='192.168.6.7'/>
    >         <host mac='52:54:00:06:00:08' name='Afoaviel-nat'  ip='192.168.6.8'/>
    >         <host mac='52:54:00:06:00:09' name='Rusaldez-nat'  ip='192.168.6.9'/>
    >         <host mac='52:54:00:06:00:0A' name='Stedigo-nat'   ip='192.168.6.10'/>
    >         <host mac='52:54:00:06:00:0B' name='Angece-nat'    ip='192.168.6.11'/>
    >         <host mac='52:54:00:06:00:0C' name='Edwalafia-nat' ip='192.168.6.12'/>
    >         <host mac='52:54:00:06:00:0D' name='Onoza-nat'     ip='192.168.6.13'/>
    >         <host mac='52:54:00:06:00:0E' name='Fosauri-nat'   ip='192.168.6.14'/>
    >         <host mac='52:54:00:06:00:0F' name='Marpus-nat'    ip='192.168.6.15'/>
    >         <host mac='52:54:00:06:00:10' name='Byflame-nat'   ip='192.168.6.16'/>
    >         <host mac='52:54:00:06:00:11' name='Grerat-nat'    ip='192.168.6.17'/>
    >         <host mac='52:54:00:06:00:12' name='Jeralenia-nat' ip='192.168.6.18'/>
    >         <host mac='52:54:00:06:00:13' name='Dwardoa-nat'   ip='192.168.6.19'/>
    >         <host mac='52:54:00:06:00:14' name='Larohac-nat'   ip='192.168.6.20'/>
    >         <host mac='52:54:00:06:00:15' name='Kaaeclya-nat'  ip='192.168.6.21'/>
    >         <host mac='52:54:00:06:00:16' name='Elirannor-nat' ip='192.168.6.22'/>
    >         <host mac='52:54:00:06:00:17' name='Jeroaveth-nat' ip='192.168.6.23'/>
    >         <host mac='52:54:00:06:00:18' name='Rorekon-nat'   ip='192.168.6.24'/>
    >         <host mac='52:54:00:06:00:19' name='Astalenna-nat' ip='192.168.6.25'/>
    >         <host mac='52:54:00:06:00:1A' name='Afib-nat'      ip='192.168.6.26'/>
    >         <host mac='52:54:00:06:00:1B' name='Lotholia-nat'  ip='192.168.6.27'/>
    >         <host mac='52:54:00:06:00:1C' name='Astilamos-nat' ip='192.168.6.28'/>
    >       </dhcp>
    >     </ip>
    >   </network>

    virsh \
        --connect ${connection:?} \
        net-define \
        "/tmp/natted.xml"

    >   Network natted defined from /tmp/natted.xml

    virsh \
        --connect ${connection:?} \
        net-dumpxml \
            natted

    >   <network ipv6='yes'>
    >     <name>natted</name>
    >     <uuid>daccf157-54eb-43fc-95a2-6b6f2ba72c35</uuid>
    >     <forward mode='nat'>
    >       <nat>
    >         <port start='1024' end='65535'/>
    >       </nat>
    >     </forward>
    >     <bridge name='virbr1' stp='off' delay='0'/>
    >     <mac address='52:54:00:00:d2:be'/>
    >     <ip family='ipv4' address='192.168.210.190' netmask='255.255.255.224'>
    >       <dhcp>
    >         <range start='192.168.210.161' end='192.168.210.188'/>
    >         <host mac='52:54:0:0:D2:A1' name='Umiawyth-nat' ip='192.168.210.161'/>
    >         <host mac='52:54:0:0:D2:A2' name='Etalema-nat' ip='192.168.210.162'/>
    >         <host mac='52:54:0:0:D2:A3' name='Greand-nat' ip='192.168.210.163'/>
    >         <host mac='52:54:0:0:D2:A4' name='Nydiralle-nat' ip='192.168.210.164'/>
    >         <host mac='52:54:0:0:D2:A5' name='Kedaekoth-nat' ip='192.168.210.165'/>
    >         <host mac='52:54:0:0:D2:A6' name='Onelith-nat' ip='192.168.210.166'/>
    >         <host mac='52:54:0:0:D2:A7' name='Elaleld-nat' ip='192.168.210.167'/>
    >         <host mac='52:54:0:0:D2:A8' name='Afoaviel-nat' ip='192.168.210.168'/>
    >         <host mac='52:54:0:0:D2:A9' name='Rusaldez-nat' ip='192.168.210.169'/>
    >         <host mac='52:54:0:0:D2:AA' name='Stedigo-nat' ip='192.168.210.170'/>
    >         <host mac='52:54:0:0:D2:AB' name='Angece-nat' ip='192.168.210.171'/>
    >         <host mac='52:54:0:0:D2:AC' name='Edwalafia-nat' ip='192.168.210.172'/>
    >         <host mac='52:54:0:0:D2:AD' name='Onoza-nat' ip='192.168.210.173'/>
    >         <host mac='52:54:0:0:D2:AE' name='Fosauri-nat' ip='192.168.210.174'/>
    >         <host mac='52:54:0:0:D2:AF' name='Marpus-nat' ip='192.168.210.175'/>
    >         <host mac='52:54:0:0:D2:B0' name='Byflame-nat' ip='192.168.210.176'/>
    >         <host mac='52:54:0:0:D2:B1' name='Grerat-nat' ip='192.168.210.177'/>
    >         <host mac='52:54:0:0:D2:B2' name='Jeralenia-nat' ip='192.168.210.178'/>
    >         <host mac='52:54:0:0:D2:B3' name='Dwardoa-nat' ip='192.168.210.179'/>
    >         <host mac='52:54:0:0:D2:B4' name='Larohac-nat' ip='192.168.210.180'/>
    >         <host mac='52:54:0:0:D2:B5' name='Kaaeclya-nat' ip='192.168.210.181'/>
    >         <host mac='52:54:0:0:D2:B6' name='Elirannor-nat' ip='192.168.210.182'/>
    >         <host mac='52:54:0:0:D2:B7' name='Jeroaveth-nat' ip='192.168.210.183'/>
    >         <host mac='52:54:0:0:D2:B8' name='Rorekon-nat' ip='192.168.210.184'/>
    >         <host mac='52:54:0:0:D2:B9' name='Astalenna-nat' ip='192.168.210.185'/>
    >         <host mac='52:54:0:0:D2:BA' name='Afib-nat' ip='192.168.210.186'/>
    >         <host mac='52:54:0:0:D2:BB' name='Lotholia-nat' ip='192.168.210.187'/>
    >         <host mac='52:54:0:0:D2:BC' name='Astilamos-nat' ip='192.168.210.188'/>
    >       </dhcp>
    >     </ip>
    >   </network>

# -----------------------------------------------------
# List the virtual machines.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        list --all

    >    Id    Name                           State
    >   ----------------------------------------------------
    >    -     Angece                         shut off
    >    -     Byflame                        shut off
    >    -     Edwalafia                      shut off
    >    -     Fosauri                        shut off
    >    -     Marpus                         shut off
    >    -     Onoza                          shut off
    >    -     Stedigo                        shut off
    >    -     Umiawyth                       shut off

# -----------------------------------------------------
# Manually update the `Umiawyth` virtual machine.
# Give it a MAC address to match the `natted` network
# and remove any other interfaces.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        dumpxml \
            'Umiawyth' \
    > "/tmp/umiawyth.xml"

    vi "/tmp/umiawyth.xml"

    -   <interface type='bridge'>
    -     <mac address='52:54:00:10:03:02'/>
    -     <source bridge='br0'/>
    -     <model type='virtio'/>
    -     <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>
    -   </interface>

        <interface type='network'>
    -    <mac address='52:54:00:00:d2:a1'/>
    +    <mac address='52:54:0:0:D2:A1'/>
          <source network='natted'/>
          <model type='virtio'/>
          <address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/>
        </interface>

    virsh \
        --connect ${connection:?} \
        define \
        "/tmp/umiawyth.xml"

    >   Domain Umiawyth defined from /tmp/umiawyth.xml

    virsh \
        --connect ${connection:?} \
        dumpxml \
            'Umiawyth' \
    | xmlstarlet \
        select \
            --root \
            --indent \
            --template \
                --copy-of '//interface'

    >   <xsl-select>
    >     <interface type="bridge">
    >         <mac address="52:54:00:10:03:02"/>
    >         <source bridge="br0"/>
    >         <model type="virtio"/>
    >         <address type="pci" domain="0x0000" bus="0x00" slot="0x03" function="0x0"/>
    >       </interface>
    >     <interface type="network">
    >         <mac address="52:54:00:00:d2:a1"/>
    >         <source network="natted"/>
    >         <model type="virtio"/>
    >         <address type="pci" domain="0x0000" bus="0x00" slot="0x07" function="0x0"/>
    >       </interface>
    >   </xsl-select>


# -----------------------------------------------------
# Manually start the `Umiawyth` virtual machine.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        start \
            'Umiawyth'

    >   Domain Umiawyth started


# -----------------------------------------------------
# Try connecting to the `Umiawyth` virtual machine.
#[user@trop03]

    source "${HOME}/ssh-options"

    ssh ${sshopts} \
        ${sshuser}@192.168.210.161 \
        '
        date
        hostname
        '

    >   Tue 19 Mar 01:16:01 GMT 2019
    >   Umiawyth-nat

    #
    # Hang on ....
    # Got the old set of IP addresses ... again.
    #

    #
    # My fault for not checking the result of the network update properly.
    # Start again.
    #


# -----------------------------------------------------
# Manually stop the `Umiawyth` virtual machine.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        shutdown \
            'Umiawyth'

    >   Domain Umiawyth is being shutdown


# -----------------------------------------------------
# Update the `natted` network.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        net-destroy \
            'natted'

    >   Network natted destroyed


    virsh \
        --connect ${connection:?} \
        net-undefine \
            'natted'

    >   Network natted has been undefined


    virsh \
        --connect ${connection:?} \
        net-define \
        "/tmp/natted.xml"


    >   Network natted defined from /tmp/natted.xml


    virsh \
        --connect ${connection:?} \
        net-dumpxml \
            'natted'


    >   <network ipv6='yes'>
    >     <name>natted</name>
    >     <uuid>daccf157-54eb-43fc-95a2-6b6f2ba72c35</uuid>
    >     <forward mode='nat'>
    >       <nat>
    >         <port start='1024' end='65535'/>
    >       </nat>
    >     </forward>
    >     <bridge name='virbr1' stp='off' delay='0'/>
    >     <mac address='52:54:00:06:00:fe'/>
    >     <ip family='ipv4' address='192.168.6.254' netmask='255.255.255.0'>
    >       <dhcp>
    >         <range start='192.168.6.1' end='192.168.6.31'/>
    >         <host mac='52:54:00:06:00:01' name='Umiawyth-nat' ip='192.168.6.1'/>
    >         <host mac='52:54:00:06:00:02' name='Etalema-nat' ip='192.168.6.2'/>
    >         <host mac='52:54:00:06:00:03' name='Greand-nat' ip='192.168.6.3'/>
    >         <host mac='52:54:00:06:00:04' name='Nydiralle-nat' ip='192.168.6.4'/>
    >         <host mac='52:54:00:06:00:05' name='Kedaekoth-nat' ip='192.168.6.5'/>
    >         <host mac='52:54:00:06:00:06' name='Onelith-nat' ip='192.168.6.6'/>
    >         <host mac='52:54:00:06:00:07' name='Elaleld-nat' ip='192.168.6.7'/>
    >         <host mac='52:54:00:06:00:08' name='Afoaviel-nat' ip='192.168.6.8'/>
    >         <host mac='52:54:00:06:00:09' name='Rusaldez-nat' ip='192.168.6.9'/>
    >         <host mac='52:54:00:06:00:0A' name='Stedigo-nat' ip='192.168.6.10'/>
    >         <host mac='52:54:00:06:00:0B' name='Angece-nat' ip='192.168.6.11'/>
    >         <host mac='52:54:00:06:00:0C' name='Edwalafia-nat' ip='192.168.6.12'/>
    >         <host mac='52:54:00:06:00:0D' name='Onoza-nat' ip='192.168.6.13'/>
    >         <host mac='52:54:00:06:00:0E' name='Fosauri-nat' ip='192.168.6.14'/>
    >         <host mac='52:54:00:06:00:0F' name='Marpus-nat' ip='192.168.6.15'/>
    >         <host mac='52:54:00:06:00:10' name='Byflame-nat' ip='192.168.6.16'/>
    >         <host mac='52:54:00:06:00:11' name='Grerat-nat' ip='192.168.6.17'/>
    >         <host mac='52:54:00:06:00:12' name='Jeralenia-nat' ip='192.168.6.18'/>
    >         <host mac='52:54:00:06:00:13' name='Dwardoa-nat' ip='192.168.6.19'/>
    >         <host mac='52:54:00:06:00:14' name='Larohac-nat' ip='192.168.6.20'/>
    >         <host mac='52:54:00:06:00:15' name='Kaaeclya-nat' ip='192.168.6.21'/>
    >         <host mac='52:54:00:06:00:16' name='Elirannor-nat' ip='192.168.6.22'/>
    >         <host mac='52:54:00:06:00:17' name='Jeroaveth-nat' ip='192.168.6.23'/>
    >         <host mac='52:54:00:06:00:18' name='Rorekon-nat' ip='192.168.6.24'/>
    >         <host mac='52:54:00:06:00:19' name='Astalenna-nat' ip='192.168.6.25'/>
    >         <host mac='52:54:00:06:00:1A' name='Afib-nat' ip='192.168.6.26'/>
    >         <host mac='52:54:00:06:00:1B' name='Lotholia-nat' ip='192.168.6.27'/>
    >         <host mac='52:54:00:06:00:1C' name='Astilamos-nat' ip='192.168.6.28'/>
    >       </dhcp>
    >     </ip>
    >   </network>


    virsh \
        --connect ${connection:?} \
        net-start \
            'natted'

    >   Network natted started


# -----------------------------------------------------
# Manually update the `Umiawyth` virtual machine and
# give it a MAC address to match the `natted` network.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        edit \
            'Umiawyth'

        <interface type='network'>
    -    <mac address='52:54:00:00:d2:a1'/>
    +    <mac address='52:54:00:06:00:01'/>
          <source network='natted'/>
          <model type='virtio'/>
          <address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/>
        </interface>


    >   Domain Umiawyth XML configuration edited.

    virsh \
        --connect ${connection:?} \
        dumpxml \
            'Umiawyth' \
    | xmlstarlet \
        select \
            --root \
            --indent \
            --template \
                --copy-of '//interface'

    >   <xsl-select>
    >     <interface type="network">
    >         <mac address="52:54:00:06:00:01"/>
    >         <source network="natted"/>
    >         <model type="virtio"/>
    >         <address type="pci" domain="0x0000" bus="0x00" slot="0x07" function="0x0"/>
    >       </interface>
    >   </xsl-select>


# -----------------------------------------------------
# Manually start the `Umiawyth` virtual machine.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        start \
            'Umiawyth'

    >   Domain Umiawyth started


# -----------------------------------------------------
# Try connecting to the `Umiawyth` virtual machine.
#[user@trop03]

    source "${HOME}/ssh-options"

    ssh ${sshopts} \
        ${sshuser}@192.168.6.1 \
        '
        date
        hostname
        '

    >   Tue 19 Mar 01:39:56 GMT 2019
    >   Umiawyth-nat


# -----------------------------------------------------
# Check the `Umiawyth` virtual machine can see an internal machine.
#[user@trop03]

    source "${HOME}/ssh-options"

    ssh ${sshopts} \
        ${sshuser}@192.168.6.1 \
        '
        curl --head --silent "http://tap.roe.ac.uk/osa/tables"
        '

    >   HTTP/1.1 200
    >   Date: Tue, 19 Mar 2019 02:43:49 GMT
    >   Server: Apache/2.4.34 (Fedora)
    >   X-Clacks-Overhead: GNU Terry Pratchett
    >   ....


# -----------------------------------------------------
# Check the `Umiawyth` virtual machine can see the outside world.
#[user@trop03]

    source "${HOME}/ssh-options"

    ssh ${sshopts} \
        ${sshuser}@192.168.6.1 \
        '
        curl --head --silent "http://data.metagrid.co.uk/temp/"
        '

    >   HTTP/1.1 200 OK
    >   Date: Tue, 19 Mar 2019 01:43:21 GMT
    >   Server: Apache/2.2.15 (CentOS)
    >   ....


# -----------------------------------------------------
# Manually stop the `Umiawyth` virtual machine.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        shutdown \
            'Umiawyth'

    >   Domain Umiawyth is being shutdown


# -----------------------------------------------------
# Delete the `routed` network.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        net-destroy \
            'routed'

    >   Network routed destroyed


    virsh \
        --connect ${connection:?} \
        net-undefine \
            'routed'

    >   Network routed has been undefined


# -----------------------------------------------------
# Create a new `routed` network.
#[user@trop03]

    vi "/tmp/routed.xml"

        <network ipv6='yes'>
          <name>routed</name>
          <uuid/>
          <bridge name='virbr0' stp='off' delay='0'/>
          <mac address='52:54:00:06:01:FE'/>
          <ip family='ipv4' address='172.16.6.254' netmask='255.255.255.0'>
            <dhcp>
              <range start='172.16.6.1' end='172.16.6.31'/>
              <host mac='52:54:00:06:01:01' name='Umiawyth'  ip='172.16.6.1'/>
              <host mac='52:54:00:06:01:02' name='Etalema'   ip='172.16.6.2'/>
              <host mac='52:54:00:06:01:03' name='Greand'    ip='172.16.6.3'/>
              <host mac='52:54:00:06:01:04' name='Nydiralle' ip='172.16.6.4'/>
              <host mac='52:54:00:06:01:05' name='Kedaekoth' ip='172.16.6.5'/>
              <host mac='52:54:00:06:01:06' name='Onelith'   ip='172.16.6.6'/>
              <host mac='52:54:00:06:01:07' name='Elaleld'   ip='172.16.6.7'/>
              <host mac='52:54:00:06:01:08' name='Afoaviel'  ip='172.16.6.8'/>
              <host mac='52:54:00:06:01:09' name='Rusaldez'  ip='172.16.6.9'/>
              <host mac='52:54:00:06:01:0A' name='Stedigo'   ip='172.16.6.10'/>
              <host mac='52:54:00:06:01:0B' name='Angece'    ip='172.16.6.11'/>
              <host mac='52:54:00:06:01:0C' name='Edwalafia' ip='172.16.6.12'/>
              <host mac='52:54:00:06:01:0D' name='Onoza'     ip='172.16.6.13'/>
              <host mac='52:54:00:06:01:0E' name='Fosauri'   ip='172.16.6.14'/>
              <host mac='52:54:00:06:01:0F' name='Marpus'    ip='172.16.6.15'/>
              <host mac='52:54:00:06:01:10' name='Byflame'   ip='172.16.6.16'/>
              <host mac='52:54:00:06:01:11' name='Grerat'    ip='172.16.6.17'/>
              <host mac='52:54:00:06:01:12' name='Jeralenia' ip='172.16.6.18'/>
              <host mac='52:54:00:06:01:13' name='Dwardoa'   ip='172.16.6.19'/>
              <host mac='52:54:00:06:01:14' name='Larohac'   ip='172.16.6.20'/>
              <host mac='52:54:00:06:01:15' name='Kaaeclya'  ip='172.16.6.21'/>
              <host mac='52:54:00:06:01:16' name='Elirannor' ip='172.16.6.22'/>
              <host mac='52:54:00:06:01:17' name='Jeroaveth' ip='172.16.6.23'/>
              <host mac='52:54:00:06:01:18' name='Rorekon'   ip='172.16.6.24'/>
              <host mac='52:54:00:06:01:19' name='Astalenna' ip='172.16.6.25'/>
              <host mac='52:54:00:06:01:1A' name='Afib'      ip='172.16.6.26'/>
              <host mac='52:54:00:06:01:1B' name='Lotholia'  ip='172.16.6.27'/>
              <host mac='52:54:00:06:01:1C' name='Astilamos' ip='172.16.6.28'/>
            </dhcp>
          </ip>
        </network>


    virsh \
        --connect ${connection:?} \
        net-define \
        "/tmp/routed.xml"


    >   Network routed defined from /tmp/routed.xml


    virsh \
        --connect ${connection:?} \
        net-dumpxml \
            'routed'


    >   <network ipv6='yes'>
    >     <name>routed</name>
    >     <uuid>792c56e9-69a8-49b0-8a77-776f7a9a7f30</uuid>
    >     <bridge name='virbr0' stp='off' delay='0'/>
    >     <mac address='52:54:00:06:01:fe'/>
    >     <ip family='ipv4' address='172.16.6.254' netmask='255.255.255.0'>
    >       <dhcp>
    >         <range start='172.16.6.1' end='172.16.6.31'/>
    >         <host mac='52:54:00:06:01:01' name='Umiawyth' ip='172.16.6.1'/>
    >         <host mac='52:54:00:06:01:02' name='Etalema' ip='172.16.6.2'/>
    >         <host mac='52:54:00:06:01:03' name='Greand' ip='172.16.6.3'/>
    >         <host mac='52:54:00:06:01:04' name='Nydiralle' ip='172.16.6.4'/>
    >         <host mac='52:54:00:06:01:05' name='Kedaekoth' ip='172.16.6.5'/>
    >         <host mac='52:54:00:06:01:06' name='Onelith' ip='172.16.6.6'/>
    >         <host mac='52:54:00:06:01:07' name='Elaleld' ip='172.16.6.7'/>
    >         <host mac='52:54:00:06:01:08' name='Afoaviel' ip='172.16.6.8'/>
    >         <host mac='52:54:00:06:01:09' name='Rusaldez' ip='172.16.6.9'/>
    >         <host mac='52:54:00:06:01:0A' name='Stedigo' ip='172.16.6.10'/>
    >         <host mac='52:54:00:06:01:0B' name='Angece' ip='172.16.6.11'/>
    >         <host mac='52:54:00:06:01:0C' name='Edwalafia' ip='172.16.6.12'/>
    >         <host mac='52:54:00:06:01:0D' name='Onoza' ip='172.16.6.13'/>
    >         <host mac='52:54:00:06:01:0E' name='Fosauri' ip='172.16.6.14'/>
    >         <host mac='52:54:00:06:01:0F' name='Marpus' ip='172.16.6.15'/>
    >         <host mac='52:54:00:06:01:10' name='Byflame' ip='172.16.6.16'/>
    >         <host mac='52:54:00:06:01:11' name='Grerat' ip='172.16.6.17'/>
    >         <host mac='52:54:00:06:01:12' name='Jeralenia' ip='172.16.6.18'/>
    >         <host mac='52:54:00:06:01:13' name='Dwardoa' ip='172.16.6.19'/>
    >         <host mac='52:54:00:06:01:14' name='Larohac' ip='172.16.6.20'/>
    >         <host mac='52:54:00:06:01:15' name='Kaaeclya' ip='172.16.6.21'/>
    >         <host mac='52:54:00:06:01:16' name='Elirannor' ip='172.16.6.22'/>
    >         <host mac='52:54:00:06:01:17' name='Jeroaveth' ip='172.16.6.23'/>
    >         <host mac='52:54:00:06:01:18' name='Rorekon' ip='172.16.6.24'/>
    >         <host mac='52:54:00:06:01:19' name='Astalenna' ip='172.16.6.25'/>
    >         <host mac='52:54:00:06:01:1A' name='Afib' ip='172.16.6.26'/>
    >         <host mac='52:54:00:06:01:1B' name='Lotholia' ip='172.16.6.27'/>
    >         <host mac='52:54:00:06:01:1C' name='Astilamos' ip='172.16.6.28'/>
    >       </dhcp>
    >     </ip>
    >   </network>


    virsh \
        --connect ${connection:?} \
        net-start \
            'routed'

    >   Network routed started


# -----------------------------------------------------
# Manually update the `Umiawyth` virtual machine and
# give it a MAC address to match the `routed` network.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        edit \
            'Umiawyth'

    +   <interface type='network'>
    +    <mac address='52:54:00:06:01:01'/>
    +     <source network='routed'/>
    +     <model type='virtio'/>
    +     <address type='pci' domain='0x0000' bus='0x00' slot='0x08' function='0x0'/>
    +   </interface>


    >   Domain Umiawyth XML configuration edited.

    virsh \
        --connect ${connection:?} \
        dumpxml \
            'Umiawyth' \
    | xmlstarlet \
        select \
            --root \
            --indent \
            --template \
                --copy-of '//interface'

    >   <xsl-select>
    >     <interface type="network">
    >         <mac address="52:54:00:06:00:01"/>
    >         <source network="natted"/>
    >         <model type="virtio"/>
    >         <address type="pci" domain="0x0000" bus="0x00" slot="0x07" function="0x0"/>
    >       </interface>
    >     <interface type="network">
    >         <mac address="52:54:00:06:01:01"/>
    >         <source network="routed"/>
    >         <model type="virtio"/>
    >         <address type="pci" domain="0x0000" bus="0x00" slot="0x08" function="0x0"/>
    >       </interface>
    >   </xsl-select>


# -----------------------------------------------------
# Manually start the `Umiawyth` virtual machine.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        start \
            'Umiawyth'

    >   Domain Umiawyth started


# -----------------------------------------------------
# Try connecting via the `natted` interface.
#[user@trop03]

    source "${HOME}/ssh-options"

    ssh ${sshopts} \
        ${sshuser}@192.168.6.1 \
        '
        date
        hostname
        '

    >   Tue 19 Mar 02:31:04 GMT 2019
    >   Umiawyth-nat


# -----------------------------------------------------
# Try connecting via the `routed` interface.
#[user@trop03]

    source "${HOME}/ssh-options"

    ssh ${sshopts} \
        ${sshuser}@172.16.6.1 \
        '
        date
        hostname
        '

    >   Tue 19 Mar 02:31:47 GMT 2019
    >   Umiawyth-nat


# -----------------------------------------------------
# -----------------------------------------------------
# Update the routing table on trop04
#[user@trop04]

    source "${HOME}/ssh-options"

    ssh trop04

        #
        # Add a specific route for the routed subnet.
        ip route add

        sudo ip route add 172.16.6.0/24 via 172.16.1.5 dev br1


    #
    # About now I realise that I've got the address numbers wrong.
    # The addresses for trop03 virtual networks should be
    #   192.168.6.0 and 172.16.6.0
    # not
    #   192.168.5.0 and 172.16.5.0
    #

    #
    # Ok, quick test to finidh this one off, and then we can
    # recreate tthe networks with the correct numbers.
    #

# -----------------------------------------------------
# Try connecting to the `Umiawyth` virtual machine via the routed network.
#[user@trop04]

    source "${HOME}/ssh-options"

    ssh -v ${sshopts} \
        ${sshuser}@172.16.6.1 \
        '
        date
        hostname
        '

    >   ssh: connect to host 172.16.6.1 port 22: Connection refused


# -----------------------------------------------------
# Check to the kernel options on trop04.
#[user@trop04]

    sudo sysctl 'net.bridge'

    >   net.bridge.bridge-nf-call-arptables = 0
    >   net.bridge.bridge-nf-call-ip6tables = 0
    >   net.bridge.bridge-nf-call-iptables = 0
    >   net.bridge.bridge-nf-filter-pppoe-tagged = 0
    >   net.bridge.bridge-nf-filter-vlan-tagged = 0
    >   net.bridge.bridge-nf-pass-vlan-input-dev = 0

    #
    # They look ok.
    #

# -----------------------------------------------------
# -----------------------------------------------------
# Check to the kernel options on trop03.
#[user@trop03]

    sudo sysctl 'net.bridge'

    >   sysctl: cannot stat /proc/sys/net/bridge: No such file or directory

    #
    # Not good.
    #

    sudo modprobe br_netfilter

    >   -


    sudo sysctl -p

    >   -


    sudo /sbin/sysctl --load /etc/sysctl.d/98-bridge.conf

    >   net.bridge.bridge-nf-call-iptables = 0
    >   net.bridge.bridge-nf-call-arptables = 0
    >   net.bridge.bridge-nf-call-ip6tables = 0
    >   net.ipv4.ip_forward = 1


    sudo sysctl 'net.bridge'

    >   net.bridge.bridge-nf-call-arptables = 0
    >   net.bridge.bridge-nf-call-ip6tables = 0
    >   net.bridge.bridge-nf-call-iptables = 0
    >   net.bridge.bridge-nf-filter-pppoe-tagged = 0
    >   net.bridge.bridge-nf-filter-vlan-tagged = 0
    >   net.bridge.bridge-nf-pass-vlan-input-dev = 0

    #
    # Ok, better.
    #


# -----------------------------------------------------
# -----------------------------------------------------
# Try connecting to the `Umiawyth` virtual machine via the routed network.
#[user@trop04]

    source "${HOME}/ssh-options"

    ssh ${sshopts} \
        172.16.6.1 \
        '
        date
        hostname
        '

    >   ssh: connect to host 172.16.6.1 port 22: Connection refused


# -----------------------------------------------------
# -----------------------------------------------------
# Noticed that the routed network is missing an element.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        net-dumpxml \
            'routed' \
    | xmlstarlet \
        select \
            --root \
            --indent \
            --template \
                --copy-of '//forward'

    >   <xsl-select/>


# -----------------------------------------------------
# Manually stop the `Umiawyth` virtual machine.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        shutdown \
            'Umiawyth'

    >   Domain Umiawyth is being shutdown

# -----------------------------------------------------
# Delete the `routed` network.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        net-destroy \
            'routed'

    >   Network routed destroyed


    virsh \
        --connect ${connection:?} \
        net-undefine \
            'routed'

    >   Network routed has been undefined


# -----------------------------------------------------
# Create a new `routed` network.
#[user@trop03]

    vi "/tmp/routed.xml"

        <network ipv6='yes'>
          <name>routed</name>
          <uuid/>
    +     <forward mode="route"/>
          <bridge name='virbr0' stp='off' delay='0'/>
          <mac address='52:54:00:06:01:FE'/>
          <ip family='ipv4' address='172.16.6.254' netmask='255.255.255.0'>
            <dhcp>
              <range start='172.16.6.1' end='172.16.6.31'/>
              <host mac='52:54:00:06:01:01' name='Umiawyth'  ip='172.16.6.1'/>
              <host mac='52:54:00:06:01:02' name='Etalema'   ip='172.16.6.2'/>
              <host mac='52:54:00:06:01:03' name='Greand'    ip='172.16.6.3'/>
              <host mac='52:54:00:06:01:04' name='Nydiralle' ip='172.16.6.4'/>
              <host mac='52:54:00:06:01:05' name='Kedaekoth' ip='172.16.6.5'/>
              <host mac='52:54:00:06:01:06' name='Onelith'   ip='172.16.6.6'/>
              <host mac='52:54:00:06:01:07' name='Elaleld'   ip='172.16.6.7'/>
              <host mac='52:54:00:06:01:08' name='Afoaviel'  ip='172.16.6.8'/>
              <host mac='52:54:00:06:01:09' name='Rusaldez'  ip='172.16.6.9'/>
              <host mac='52:54:00:06:01:0A' name='Stedigo'   ip='172.16.6.10'/>
              <host mac='52:54:00:06:01:0B' name='Angece'    ip='172.16.6.11'/>
              <host mac='52:54:00:06:01:0C' name='Edwalafia' ip='172.16.6.12'/>
              <host mac='52:54:00:06:01:0D' name='Onoza'     ip='172.16.6.13'/>
              <host mac='52:54:00:06:01:0E' name='Fosauri'   ip='172.16.6.14'/>
              <host mac='52:54:00:06:01:0F' name='Marpus'    ip='172.16.6.15'/>
              <host mac='52:54:00:06:01:10' name='Byflame'   ip='172.16.6.16'/>
              <host mac='52:54:00:06:01:11' name='Grerat'    ip='172.16.6.17'/>
              <host mac='52:54:00:06:01:12' name='Jeralenia' ip='172.16.6.18'/>
              <host mac='52:54:00:06:01:13' name='Dwardoa'   ip='172.16.6.19'/>
              <host mac='52:54:00:06:01:14' name='Larohac'   ip='172.16.6.20'/>
              <host mac='52:54:00:06:01:15' name='Kaaeclya'  ip='172.16.6.21'/>
              <host mac='52:54:00:06:01:16' name='Elirannor' ip='172.16.6.22'/>
              <host mac='52:54:00:06:01:17' name='Jeroaveth' ip='172.16.6.23'/>
              <host mac='52:54:00:06:01:18' name='Rorekon'   ip='172.16.6.24'/>
              <host mac='52:54:00:06:01:19' name='Astalenna' ip='172.16.6.25'/>
              <host mac='52:54:00:06:01:1A' name='Afib'      ip='172.16.6.26'/>
              <host mac='52:54:00:06:01:1B' name='Lotholia'  ip='172.16.6.27'/>
              <host mac='52:54:00:06:01:1C' name='Astilamos' ip='172.16.6.28'/>
            </dhcp>
          </ip>
        </network>


    virsh \
        --connect ${connection:?} \
        net-define \
        "/tmp/routed.xml"

    >   Network routed defined from /tmp/routed.xml


    virsh \
        --connect ${connection:?} \
        net-dumpxml \
            'routed' \
    | xmlstarlet \
        select \
            --root \
            --indent \
            --template \
                --copy-of '//forward'

    >   <xsl-select>
    >     <forward mode="route"/>
    >   </xsl-select>


    virsh \
        --connect ${connection:?} \
        net-start \
            'routed'

    >   Network routed started


# -----------------------------------------------------
# Manually start the `Umiawyth` virtual machine.
#[user@trop03]

    virsh \
        --connect ${connection:?} \
        start \
            'Umiawyth'

    >   Domain Umiawyth started


# -----------------------------------------------------
# Try connecting via the `natted` interface.
#[user@trop03]

    source "${HOME}/ssh-options"

    ssh ${sshopts} \
        ${sshuser}@192.168.6.1 \
        '
        date
        hostname
        '

    >   Tue 19 Mar 03:07:34 GMT 2019
    >   Umiawyth-nat


# -----------------------------------------------------
# Try connecting via the `routed` interface.
#[user@trop03]

    source "${HOME}/ssh-options"

    ssh ${sshopts} \
        ${sshuser}@172.16.6.1 \
        '
        date
        hostname
        '

    >   Tue 19 Mar 03:07:48 GMT 2019
    >   Umiawyth-nat


# -----------------------------------------------------
# -----------------------------------------------------
# Try connecting to the `Umiawyth` virtual machine from trop04.
#[user@trop04]

    source "${HOME}/ssh-options"

    ssh -v ${sshopts} \
        172.16.6.1 \
        '
        date
        hostname
        '

    >   hangs ....


# -----------------------------------------------------
# -----------------------------------------------------
# We end up with two routes for the same ip range.
#[user@trop03]

    ip route

    >   default via 129.215.175.126 dev br0 onlink
    >   129.215.175.0/24 dev br0 proto kernel scope link src 129.215.175.98
    >   172.16.0.0/16 dev br1 proto kernel scope link src 172.16.1.5
    >   172.16.6.0/24 dev virbr0 proto kernel scope link src 172.16.6.254
    >   192.168.6.0/24 dev virbr1 proto kernel scope link src 192.168.6.254


    ip rule show

    >   0:	from all lookup local
    >   32766:	from all lookup main
    >   32767:	from all lookup default


    ip route show table local

    >   broadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1
    >   local 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1
    >   local 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1
    >   broadcast 127.255.255.255 dev lo proto kernel scope link src 127.0.0.1
    >   broadcast 129.215.175.0 dev br0 proto kernel scope link src 129.215.175.98
    >   local 129.215.175.98 dev br0 proto kernel scope host src 129.215.175.98
    >   broadcast 129.215.175.255 dev br0 proto kernel scope link src 129.215.175.98
    >   broadcast 172.16.0.0 dev br1 proto kernel scope link src 172.16.1.5
    >   local 172.16.1.5 dev br1 proto kernel scope host src 172.16.1.5
    >   broadcast 172.16.1.255 dev br1 proto kernel scope link src 172.16.1.5
    >   broadcast 172.16.6.0 dev virbr0 proto kernel scope link src 172.16.6.254
    >   local 172.16.6.254 dev virbr0 proto kernel scope host src 172.16.6.254
    >   broadcast 172.16.6.255 dev virbr0 proto kernel scope link src 172.16.6.254
    >   broadcast 172.16.255.255 dev br1 proto kernel scope link src 172.16.1.5
    >   broadcast 192.168.6.0 dev virbr1 proto kernel scope link src 192.168.6.254
    >   local 192.168.6.254 dev virbr1 proto kernel scope host src 192.168.6.254
    >   broadcast 192.168.6.255 dev virbr1 proto kernel scope link src 192.168.6.254


    ip route show table main

    >   default via 129.215.175.126 dev br0 onlink
    >   129.215.175.0/24 dev br0 proto kernel scope link src 129.215.175.98
    >   172.16.0.0/16 dev br1 proto kernel scope link src 172.16.1.5
    >   172.16.6.0/24 dev virbr0 proto kernel scope link src 172.16.6.254
    >   192.168.6.0/24 dev virbr1 proto kernel scope link src 192.168.6.254


    ip route show table default

    >   -


ip route get 172.16.6.1

    >   172.16.6.1 dev virbr0 src 172.16.6.254
    >       cache


ip route get 172.16.0.6

    >   172.16.0.6 dev br1 src 172.16.1.5
    >       cache

    #
    # Ok so far ...
    #

# -----------------------------------------------------
# -----------------------------------------------------
# Check the routes on trop04.
#[user@trop03]

ip route get 172.16.6.1

    >   172.16.6.1 via 172.16.1.5 dev br1  src 172.16.1.6
    >       cache

ip route get 172.16.1.5

    >   172.16.1.5 dev br1  src 172.16.1.6
    >       cache

    #
    # Ok so far ...
    #

    #
    # But .. the subnet is not reachable because our networks overlap ?
    # The smaller /24 subnet is contained within the /16 network.
    #

    #
    # Need to use two separate higher level networks.
    #


        # VLAN network
        172.16.x.y/16

        # Natted subnets
        192.168.x.y/24

        # Routed subnets
        172.17.x.y/24

    #
    # Continued in next notes ...
    #



